
@{
    ViewData["Title"] = "Address";
}

<h1>Address</h1>
<select id="select1"></select>
<select id="select2"></select>
<select id="select3"></select>

@section Scripts{
    <script>
    @*const selCity = document.querySelector("#select1");
    selCity.addEventListener("change", () => {
        console.log(selCity.options[selCity.selectedIndex].value);
        let city = selCity.options[selCity.selectedIndex].value;
        xhr1.open("get", "@Url.Content("~/api/Districts?city=")" + city);
        xhr1.send();
    })
    const selDistrict = document.querySelector("#select2");
    selDistrict.addEventListener("change", () => {
        console.log(selDistrict.options[selDistrict.selectedIndex].value);
        let district = selDistrict.options[selDistrict.selectedIndex].value;
        xhr2.open("get", "@Url.Content("~/api/Roads?siteid=")" + district);
        xhr2.send();
    })
    const selRoad = document.querySelector("#select3");
    selRoad.addEventListener("change", () => {
        console.log(selRoad.options[selRoad.selectedIndex].value);
    })
    const xhr = new XMLHttpRequest();
    xhr.addEventListener("load", () => {
        const datas = JSON.parse(xhr.responseText);
        //console.log(datas);
        //console.log(JSON.parse(datas));
        selCity.length = 0;
        datas.forEach((item) => {
            //console.log(item.city);
            const opt = new Option(item.city, item.city);
            selCity.options.add(opt);
        })
        let city = selCity.options[selCity.selectedIndex].value;
        //console.log(city);
        //console.log("@Url.Content("~/api/Districts?city=")" + city);
        xhr1.open("get", "@Url.Content("~/api/Districts?city=")" + city);
        xhr1.send();
    })
    xhr.open("get","@Url.Content("~/api/city")");
    xhr.send();
    const xhr1 = new XMLHttpRequest();
    xhr1.addEventListener("load", () => {
        const datas = JSON.parse(xhr1.responseText);
        //console.log(datas);
        selDistrict.length = 0;
        datas.forEach((item) => {
            //console.log(item.city);
            const opt = new Option(item.siteId, item.siteId);
            selDistrict.options.add(opt);
        })
        let district = selDistrict.options[selDistrict.selectedIndex].value;
        xhr2.open("get", "@Url.Content("~/api/Roads?siteid=")" + district);
        xhr2.send();
    })
    const xhr2 = new XMLHttpRequest();
    xhr2.addEventListener("load", () => {
        const datas = JSON.parse(xhr2.responseText);
        //console.log(datas);
        selRoad.length = 0;
        datas.forEach((item) => {
            //console.log(item.city);
            const opt = new Option(item.road, item.road);
            selRoad.options.add(opt);
        })
    })*@

        @*const selCity = document.querySelector('#select1');
        const selDistrict = document.querySelector('#select2');
        const selRoad = document.querySelector('#select3');
        selCity.addEventListener('change',()=> {
            const city = selCity.options[selCity.selectedIndex].value;
            ajaxCall("@Url.Content("~/api/districts")?city=" + city )
            .then(datas => {
                renderDistrict(datas);
                const district = selDistrict.options[selDistrict.selectedIndex].value;
                return ajaxCall("@Url.Content("~/api/Roads")?siteid=" + district )
            })
            .then(datas => {
                renderRoad(datas);
            })
            .catch(error => {
                console.log("有錯誤：" + error);
            })
        })
        selDistrict.addEventListener('change',()=> {
            const district = selDistrict.options[selDistrict.selectedIndex].value;
            ajaxCall("@Url.Content("~/api/Roads")?siteid=" + district )
            .then(datas => {
                renderRoad(datas);
            })
            .catch(error => {
                console.log("有錯誤：" + error);
            })
        })

        ajaxCall("@Url.Content("~/api/city")")
            .then(datas => {
                renderCity(datas);
                const city = selCity.options[selCity.selectedIndex].value;
                return ajaxCall("@Url.Content("~/api/districts")?city=" + city )
            })
            .then(datas => {
                renderDistrict(datas);
                const district = selDistrict.options[selDistrict.selectedIndex].value;
                return ajaxCall("@Url.Content("~/api/Roads")?siteid=" + district )
            })
            .then(datas => {
                renderRoad(datas);
            })
            .catch(error => {
                console.log("有錯誤：" + error);
            })

        function ajaxCall(url) {
            const promise = new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.addEventListener('load', () => {
                    if (xhr.status == 200) {
                        resolve(JSON.parse(xhr.responseText)) //轉型成JSON物件
                    } else {
                        reject(Error(xhr.status));
                    }
                })
                xhr.open("get", url);
                xhr.send();
            })
            return promise;
        }

        function renderCity(datas) {
            datas.forEach(item => {
                const opt = new Option(item.city, item.city);
                selCity.options.add(opt);
            })
        }
        function renderDistrict(datas) {
            selDistrict.length = 0;
            datas.forEach(item => {
                const opt = new Option(item.siteId, item.siteId);
                selDistrict.options.add(opt);
            })
        }
        function renderRoad(datas) {
            selRoad.length = 0;
            datas.forEach(item => {
                const opt = new Option(item.road, item.road);
                selRoad.options.add(opt);
            })
        }*@

        @*const selCity = document.querySelector('#select1');
        const selDistrict = document.querySelector('#select2');
        const selRoad = document.querySelector('#select3');
        selCity.addEventListener('change',()=> {
            const city = selCity.options[selCity.selectedIndex].value;
            fetch("@Url.Content("~/api/districts")?city=" + city )
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderDistrict(datas);
                const district = selDistrict.options[selDistrict.selectedIndex].value;
                return fetch("@Url.Content("~/api/Roads")?siteid=" + district )
            })
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderRoad(datas);
            })
            .catch(error => {
                console.log("有錯誤：" + error);
            })
        })
        selDistrict.addEventListener('change',()=> {
            const district = selDistrict.options[selDistrict.selectedIndex].value;
            fetch("@Url.Content("~/api/Roads")?siteid=" + district )
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderRoad(datas);
            })
            .catch(error => {
                console.log("有錯誤：" + error);
            })
        })

        fetch("@Url.Content("~/api/city")")
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderCity(datas);
                const city = selCity.options[selCity.selectedIndex].value;
                return fetch("@Url.Content("~/api/districts")?city=" + city )
            })
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderDistrict(datas);
                const district = selDistrict.options[selDistrict.selectedIndex].value;
                return fetch("@Url.Content("~/api/Roads")?siteid=" + district )
            })
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderRoad(datas);
            })
            .catch(error => {
                console.log("有錯誤：" + error);
            })

        function renderCity(datas) {
            datas.forEach(item => {
                const opt = new Option(item.city, item.city);
                selCity.options.add(opt);
            })
        }
        function renderDistrict(datas) {
            selDistrict.length = 0;
            datas.forEach(item => {
                const opt = new Option(item.siteId, item.siteId);
                selDistrict.options.add(opt);
            })
        }
        function renderRoad(datas) {
            selRoad.length = 0;
            datas.forEach(item => {
                const opt = new Option(item.road, item.road);
                selRoad.options.add(opt);
            })
        }*@

        const selCity = document.querySelector('#select1');
        const selDistrict = document.querySelector('#select2');
        const selRoad = document.querySelector('#select3');

        //IIFE 立即執行函式
            (async function LoadAddress() {
                //載入城市
                const cityResponse = await fetch("@Url.Content("~/api/city")");
                renderCity(await cityResponse.json());
                //載入城市
                const city = selCity.options[selCity.selectedIndex].value;
                const districtResponse = await fetch("@Url.Content("~/api/districts")?city=" + city );
                renderDistrict(await districtResponse.json());
                //載入路名
                const district = selDistrict.options[selDistrict.selectedIndex].value;
                const roadResponse = await fetch("@Url.Content("~/api/Roads")?siteid=" + district )
                renderRoad(await roadResponse.json());
            } )();


        selCity.addEventListener('change', async ()=> {
            const city = selCity.options[selCity.selectedIndex].value;
            const districtResponse = await fetch("@Url.Content("~/api/districts")?city=" + city )
            renderDistrict(await districtResponse.json());
            const district = selDistrict.options[selDistrict.selectedIndex].value;
            const roadResponse = await fetch("@Url.Content("~/api/Roads")?siteid=" + district )
            renderRoad(await roadResponse.json());
        })
        selDistrict.addEventListener('change', async ()=> {
            const district = selDistrict.options[selDistrict.selectedIndex].value;
            const roadResponse = await fetch("@Url.Content("~/api/Roads")?siteid=" + district )
            renderRoad(await roadResponse.json());
        })


        @*fetch("@Url.Content("~/api/city")")
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderCity(datas);
                const city = selCity.options[selCity.selectedIndex].value;
                return fetch("@Url.Content("~/api/districts")?city=" + city )
            })
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderDistrict(datas);
                const district = selDistrict.options[selDistrict.selectedIndex].value;
                return fetch("@Url.Content("~/api/Roads")?siteid=" + district )
            })
            .then(response => {
                return response.json();
            })
            .then(datas => {
                renderRoad(datas);
            })
            .catch(error => {
                console.log("有錯誤：" + error);
            })*@

        function renderCity(datas) {
            datas.forEach(item => {
                const opt = new Option(item.city, item.city);
                selCity.options.add(opt);
            })
        }
        function renderDistrict(datas) {
            selDistrict.length = 0;
            datas.forEach(item => {
                const opt = new Option(item.siteId, item.siteId);
                selDistrict.options.add(opt);
            })
        }
        function renderRoad(datas) {
            selRoad.length = 0;
            datas.forEach(item => {
                const opt = new Option(item.road, item.road);
                selRoad.options.add(opt);
            })
        }

    </script>
}
